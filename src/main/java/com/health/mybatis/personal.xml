<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.health.mybatis">

    <select id="memberWishPosts" resultType="Map" parameterType="Map">
        SELECT * From(
        select rownum rnum,p.postno as postNo, title, postimg from post p
        inner join USERLIKE u
        on p.postno = u.postno WHERE userno = #{userNo} AND p.DELETEDDATE is NULL ORDER BY LIKEKEY DESC)
        where rnum <![CDATA[>=]]> #{idx} AND rnum <![CDATA[<]]> #{idx}+8
    </select>
    <select id="memberInfo" resultType="MemberDto" parameterType="int">
        select * from member where userno = #{userNo}
    </select>
    <select id="memberPassword" resultType="String" parameterType="int">
        select pw from member where userno = #{userNo}
    </select>
    <update id="memWithdraw" parameterType="int">
        update member set deleteddate = sysdate where userno = #{userNo}
    </update>
    <update id="updateEnterprise" parameterType="EnterpriseDto">
        update enterprise set tel=#{tel}, ceo=#{ceo}, address=#{address}, addressDetail=#{addressDetail} where enterpriseNo = #{enterpriseNo}
    </update>
    <select id="enterpriseInfo" resultType="EnterpriseDto" parameterType="int">
        select * from enterprise where enterpriseNo = #{enterpriseNo}
    </select>
    <select id="enterprisePassword" resultType="String" parameterType="int">
        select pw from enterprise where enterpriseNo = #{enterpriseNo}
    </select>
    <update id="updateEntPassword" parameterType="EnterpriseDto">
        update enterprise set pw = #{pw} where enterpriseNo=#{enterpriseNo}
    </update>
    <update id="entWithdraw" parameterType="int">
        update enterprise set deleteddate = sysdate where enterpriseNo = #{enterpriseNo}
    </update>
    <update id="entProfileImg" parameterType="EnterpriseDto">
        update enterprise set profile = #{profile} where enterpriseNo = #{enterpriseNo}
    </update>
    <select id="entPosts" resultType="Map" parameterType="Map">
<!--        select (SELECT count(*) FROM userlike WHERE POSTNO = ) AS likes,-->
<!--        postimg,rowNum, postNo, title, to_char(regDate,'yyyy.mm.dd') as regDate-->
<!--        from post where enterpriseNo = 3 and deletedDate is NULL-->

        SELECT * FROM(
        SELECT rownum rnum, b.* from
        (SELECT a.* FROM(
        SELECT likes, postimg, p.postNo, title, to_char(regDate,'yyyy.mm.dd') as regDate from post p
        left JOIN (SELECT userlike.POSTNO ,count(*) likes FROM USERLIKE
        inner JOIN post ON
        post.postno = userlike.POSTNO WHERE deleteddate IS NULL GROUP BY userlike.POSTNO) u ON u.POSTNO = p.POSTNO
        where enterpriseNo = #{enterpriseNo} and deletedDate is NULL) a ORDER BY regdate desC) b)
        WHERE rnum <![CDATA[>=]]> #{idx} and rnum <![CDATA[<]]> #{idx} + 10

    </select>
<!--    member review 조회-->
    <select id="memReview" resultType="Map" parameterType="Map">
<!--        SELECT a.* from-->
<!--        (SELECT rownum rnum, postimg, REVIEWNO, r.postno AS postno, r.title AS title,-->
<!--        to_char(r.regdate, 'yyyy.mm.dd') AS regdate, p.title AS postTitle, r.DELETEDDATE rivewdeleteddate,-->
<!--        p.DELETEDDATE AS postdeleteddate-->
<!--        FROM REVIEW r left JOIN post p-->
<!--        ON r.postno = p.postno WHERE USERno = #{no} and r.deleteddate is null) a-->
<!--        WHERE rnum <![CDATA[<]]> #{idx}+10 and rnum <![CDATA[>=]]> #{idx}-->

        SELECT b.* from(
        SELECT rownum as rnum, a.* from
        (SELECT postimg, REVIEWNO, r.postno AS postno, r.title AS title,
        to_char(r.regdate, 'yyyy.mm.dd') AS regdate, p.title AS postTitle, r.DELETEDDATE rivewdeleteddate,
        p.DELETEDDATE AS postdeleteddate
        FROM REVIEW r left JOIN post p
        ON r.postno = p.postno WHERE USERno = #{56} and r.deleteddate is NULL order BY regdate desc) a ) b
        WHERE rnum <![CDATA[<]]> #{idx}+10 and rnum <![CDATA[>=]]> #{idx}
    </select>
    <select id="merReviewsCount" resultType="int" parameterType="int">
        SELECT count(*) FROM REVIEW WHERE USERNO = ${no} AND DELETEDDATE IS null
    </select>
    <select id="totalMemWish" resultType="int" parameterType="int">
        SELECT count(*) FROM USERLIKE
        inner JOIN post ON
        post.postno = userlike.POSTNO WHERE userno = #{no} AND deleteddate IS null
    </select>
    <select id="totalEntPosts" parameterType="int" resultType="int">
        SELECT count(*) FROM post WHERE ENTERPRISENO = #{no} AND DELETEDDATE IS null
    </select>
</mapper>